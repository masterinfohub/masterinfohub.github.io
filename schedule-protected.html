<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noindex, nofollow">
    <title>Password Protected Page</title>
    <style>
        html, body {
            margin: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, Helvetica, sans-serif;
        }
        #dialogText {
            color: white;
            background-color: #333333;
        }
        
        #dialogWrap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: table;
            background-color: #EEEEEE;
        }
        
        #dialogWrapCell {
            display: table-cell;
            text-align: center;
            vertical-align: middle;
        }
        
        #mainDialog {
            max-width: 400px;
            margin: 5px;
            border: solid #AAAAAA 1px;
            border-radius: 10px;
            box-shadow: 3px 3px 5px 3px #AAAAAA;
            margin-left: auto;
            margin-right: auto;
            background-color: #FFFFFF;
            overflow: hidden;
            text-align: left;
        }
        #mainDialog > * {
            padding: 10px 30px;
        }
        #passArea {
            padding: 20px 30px;
            background-color: white;
        }
        #passArea > * {
            margin: 5px auto;
        }
        #pass {
            width: 100%;
            height: 40px;
            font-size: 30px;
        }
        
        #messageWrapper {
            float: left;
            vertical-align: middle;
            line-height: 30px;
        }
        
        .notifyText {
            display: none;
        }
        
        #invalidPass {
            color: red;
        }
        
        #success {
            color: green;
        }
        
        #submitPass {
            font-size: 20px;
            border-radius: 5px;
            background-color: #E7E7E7;
            border: solid gray 1px;
            float: right;
            cursor: pointer;
        }
        #contentFrame {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #attribution {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            font-size: 0.8em;
        }
        #attribution, #attribution a {
            color: #999;
        }
        .error {
            display: none;
            color: red;
        }
    </style>
  </head>
  <body>
    <iframe id="contentFrame" frameBorder="0" allowfullscreen></iframe>
    <div id="dialogWrap">
        <div id="dialogWrapCell">
            <div id="mainDialog">
                <div id="dialogText">This page is password protected.</div>
                <div id="passArea">
                    <p id="passwordPrompt">Password</p>
                    <input id="pass" type="password" name="pass" autofocus>
                    <div>
                        <span id="messageWrapper">
                            <span id="invalidPass" class="error">Sorry, please try again.</span>
                            <span id="trycatcherror" class="error">Sorry, something went wrong.</span>
                            <span id="success" class="notifyText">Success!</span>
                            &nbsp;
                        </span>
                        <button id="submitPass" type="button">Submit</button>
                        <div style="clear: both;"></div>
                    </div>
                </div>
                <div id="securecontext" class="error">
                    <p>
                        Sorry, but password protection only works over a secure connection. Please load this page via HTTPS.
                    </p>
                </div>
                <div id="nocrypto" class="error">
                    <p>
                        Your web browser appears to be outdated. Please visit this page using a modern browser.
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div id="attribution">
        Protected by <a href="https://www.maxlaumeister.com/pagecrypt/">PageCrypt</a>
    </div>
    <script>
    (function() {

        var pl = "Pz0sOVLrTgc3KbKa857bM8nf68J9SZB1tY7qBLfZ6UdEPeODAb9mW9ubkcaKdpWtjQIzudtJxx6o+4ifcIctKWzpXk9PrQJtXxzEiwnnaRopOeAiFV1cfEkGc4Qjx+KJeha1cFKhywFWGoISz593xkDrlmhpZAwDHa+2t3xcSrkpsDiN9kIfEMELJ56zMV3bW5G84gU4Au0RWhIM4j+TRC8kSPqzJqs/JoEpyaTsmplivQhLCm66+p74m+QVxKwmm5tWaTzhVj2tPgXDFlfgMRV1/QNFP+0ltZRhNgo6pbzBbyQy4qxF655EE+IDC44IaXxs/1IUhkPsJOkb1YNDqg+5r4bQyTrya5L3N0I4Z4g7gtZedeD/UzGYBrNPDY4/DnPJGMB3JnA07IEfFHV7xRu4lYbIwq0oP3K+96oWo09pQ9k8nhv+mHtpk7MG9QlzSZtuVON42tonbMXX1A3bOQVwndvXCDAGRrN1Yr2eZrp1VVoeTKpwBceHBmMGZvUBQXIkUPn/umcuElz6G1jPV4wjYFQbNhNdYAnboVrxFlMvNsPN38ivJnr2rJPshshO7w4B5VCklmH9rw2RpebtYsVtIMND0zdxergEsLsEVc/PMrJDidPEdrWnDXoq5ZYGfZH9De16WL4HEyHj6Ji2Qs97Tebd49v0+HTg1sU68f2cgIVmDwDjFoNIQkIkw4ckuGUe3HsHHwBO6WxbZBZz/Dqz32Wh5wqPQhngOjUWeIvMO8r3GIQ1QjbzgDhGOiCMSEd1SSjOQG/PaVPQRGLdnI6lNMGgKwvIAW2JA2bOvv0ybsFpCtn75p1itNBMQ4YaEfGMGn3eZl8Cmd2qMQOc48j6jBv7tyeLLaRaCLkAWgyaz+vE43fj04bhl1drB2P5KeG6xjmvDcS3iQ6OY9OqV0FmrckocZgPhKBNNRatV1JNu/ltb5DKBC8nXoyccM3P4gTUcMdCt3RcLP1g9ZZfaMwHbdTozd8y1uYrPi9aag/dL2Q6TCzPWFkJLE39JsfPkJiNdgvWa8OJQ2MaxPlZwaLYj/d/aBUfS6vVeo3CwEIdC999DjYUEFbTxgZk0TtI+CrmdXoiwY8QsU0XalwDslCpsnRh/11YTWFq0lPWxajciwcdu+OZicf+8XbXyMJK6Ms/8uVnwog2XWsIeAasebvCVyqGL9aYnzh9LVjI2p/yPmsWpHCM+DivTXwHrDl2EHRvTFKt2ZAarB0yrVlBA0320lujPN3e/YrrR4CPov1UU/V0PZudCixLreVrLRF0xzCoR/baV9k+ehTq79FDvkftrJkUTsQDn3drBCTQEuhcHqqFfmEjMr6f+OLDZvbgPWp4WWprlDi35mFJE9+56iXiGHAi7sNYIEeA8L0X8ABw0LwG+vuSMyJ1pikcIBnVgZBqBGM5bnQBgjEr3OrHWpAbBqVEyL5dTyl44JP6WJ8GbvAT74J6mnZnVl6QLQhfaseUungEOpYgQC91JZrJQhBYVsRp/UZb3qr6jKQF9zeOxip8BKXxJl9RSyhOfd2t0Pf+ZLi63giik1PUIjf5JnTh39/yyNT0J4Lny7PDfgNHuAN0HY12pDtyce2nSldxtTYRdgEkLmqAcExjUGD8S6AIubCAnX7eq3zm6IXt9dx//ZEfmCn80GKKK1W3rugNwbmTWiwqQa4Xq1qMBz3jU6ar1cKPKedbEsemiL1B85FTv6d/2PV60HMEdcVts/t4UUi3E08RKcu1oATzwvsc7LGgbfj7YM4kZJv4m95UFRV5J2LTBcxLlJlry3+In9clCWRpazYW5nrgI7B3QgPrp9QKWNPD3cudO6bFsJY+LnHLuZe8FizQ9uJaw4rep8ES+Wmcmh5NHQQNo3qxozfu4U5ebDyGuL6LYVgYtV0URCJ8h+r2EqI6IcFt1VenP2XInoFaZVM4F4Z6ncn/g7FZzxMRgAP+EZlHeLZ1URz/Upu+hJaRuHhpDljWAviCFJA9+ZiG9q32Dq5rZipBmzyMjPLwN9PXnUkbhgcYR6FgnRn/7tsaZVgxdzwbJF4qDgG99QLSabO93qvet6cLr+MYt9rEHRIStzUexu/H21zdBQIaXycIBG/3ys9sNHShbH/+6bfK3N591KGsyaID8xOg46e6MMJWwuIcjsNmpOynBRQIjRGxSvsuFE+SHkOvz5Ui9uFLI/tF400NOMOxmki4wyB/jFfsoEIVmXSpZThi17hMLkUe5++b6K1jGhLgf0brP6FgiqgLdOrjmJZn3UInjEVbdjolPnMoI/fEWl9D7XnV+CHAZ6RemxlQwVFbsFJtASMTLOAfUo5bLAPMvNPP6LsA2bOqfloGFEyPfUycH1z4fRZ5cHGPY6ABw0JgSgK8WLjwr+67czj7jQkJ5jtDzHqRN8W4EK0Hyfh6n0ajqyY4FNDECVWXhmQTiY5Ek98gsfVhYnUogsw9SkwBqx5LtE2HYb0VnzLP/WK7gkXScSS0JjWEMb+wyNwVuD7R9uXvLlhN3i3nZkqL7en5EBiYjskyHBJQ3YAiNMP5DGNgPiC8jBCqLlyNKTOqTp4eyzqCDhNFhtFZE2jlHsd7I/siEPUwqRsuaHm4R99Z7kEWef5YvWrbYRYAHUTGza52BqLxIpM2nvEAtEPz5PLn8SD/Zt67H0Ziw612jgW5GcDqbOvKO7SzmSuzCgckBE7qiHk2mlD1ieDJesCIkELN1f2bDwCKF++hfmInoGhrgu8OpjAHR8Civ8muiwhBXIs1Vo7y6OwQbtf3ntF+/3UzoOgNHmRdQ0XvLyDbjqnHBwH++lpmkl1jGcCKDqByUTQEg9u0z45aVM3IgRMH78i9QuWcXVowGY61hiKzuAClI2OvD6wgP/snWbP2N0tPCOgcIX4DIDS1M2aVuUNyGt2xX/ZR1zGnr3d+vsyqg2IW3UXApuSBszXv1SvNpCMRgwRj3pp/FolR2Y70PfLGp9L4mEtB4Ev3wMk3N5G0vVybpEwh7gFuTBYv/p+46L1ZBzwUh39MYKuzfef7Z2ILTXfq2riZUyfyH2fls/j+grIWqs79SKjB66+J/HikiGWPd57eKV/4QxTUeUY8ltqfJypuqRHWK9g4nRSa8SOtNGt5ckxmnixzhzQy8pXOQdVBGyWWKkmQzyaLb6FjwKsjD+uW7mjmBba3Z5PJQUaiEFYU2EQKpKvdSw6HuXcdnFDBGsswyJ8Z41Zys1adz+kjkjMTaPC42lvPhQWaZdw/oLjuLPvlw0ZVSR+9oW5p8n5NOvBRkZMkbxug/YLsdiXFF15gtbGuHq4Y1Mj9i11ZQRt1O1mfY7uiXXlsPQ/VPueZbBqpm5rUbdxyn1K+U77JF54RIQ+h0lJHa9g+wivYSEuWWKvBh1DQgSkI0GZLdonih6b2HW+S2hRcIMhcRBxeCCdDnKoKxesQB6EU4lmC6O0HIg59bCD5zFb9eLz47E4/LdWT7qYE2pmjEXr8XnZeJlXnO7pAwh9BepnaAkrLs1L2/9nG550hpCZeZCMWylBymh+QQV9gIDE9lOJtEa1h2P3gwqhDcpcWjds45Qio3cLlY5BJCwxy4IatQQ8GDTh2kkZOZ6tYBG0TkpMlsOpC8fH0pR2QOB4NwNHwg9QRCib/JAAIQSjFPfjdS2ypP57OWqb/tyOO93ijsUu3/oE/ZZUn6HjnEl0XfVQBtlLawqvMd6RUFos8ETufQ0danm3qRhNetdABCUNqvQ7p3oSbvYt1R9aR8wPaFRFClRDSnwkUIF2LkK0ZHY+S0eeCkbbc9z/0XR6u4XKbEDGJpKupBp4SueISn4PU1GjkJBiaS43+e6+QFod547EzNSRuRKawChOZx0/uL4mlJOxvYTu5p8+xu40V+T2MZUOOmCPnf7t0YqACuH4kFPchsJbRLgTnSPw7v+SkvsBp/tmAMQ8mRjno2fajxvRVj6/DyMomQnXv8JZZjFU61PLZs+tffY5P/wuJuy+Iv+amQA8YO/+r5lW/8TXZunbk6yoE8o1dE43e8MCacbYaff452oWqCN2I80iW3BDQcCRPNoIkQ/2ABzXYiCWfIQu8dxIRQ+4rr8mvylnh89/oBCoa5H1uBPd4c+yyDQGzFgB3SkqV/fqt3MdB25CD9A1so0Ikh5f0pl8FaYoHRX4GLYlxjlzz6fggtpc+duyso+2hHe5CWAXHa1cyPiJcMY0CIduUu9Gb0qLAQTB/zVFRiai2pHgdrhfL9RYRP7jSyZAmOAs7yArL7SIbvifAz2dIgk8qJc/LJw4YOyCRt7CRqd4ovBOabssFt7n3oPSb1/J8/POdcBvVijWv6473xe2TBbZfTcpScM+ud71P9TDv1m0em5ULJD/2i+L0GU1LItGtB566qcziPgMQv9fquWO2az9Ijr1iV26+zarpovyCZV47D0CFyEvNvdWYIjhMhLhVTWf+S42Jltt2HE2oRrJ5Zf3bsOppueVVpbyn2cTuHt1brt/4hgGst96N0SAqhehakigxkVBjqG2Ww6iyZUf4gGruyVxgTX9/sxWYyjeQcDBK08m/ZGviS8tiDErQyMje9GF0knWxZ5lu3c+ajAfV8ZulSCE02ADEdQFvBbo84pjRLhWxPIP7AMZHcIHJ7yva/+ICTSVISKhWFrsspXQKXqCphr4cYta885gsNPgH0uGXwRnkiMHRNoIF+SwJqlVjL475Vj27pFM5nvpIG5r/MXArVGSL0WulLC4d7vdstBHGX7xClzYkfn0QP3AZ6kZYYEFD+Eo6X/5896Igwaw1Dgk1qQLsI7RxPbu3fG8LRWtPDSlmzxkmpzE02yoaeWfUodxue/KXvDwWL0uz4Kao9VmIfo0WD2wm2kcJjB8oEY5fYeNBOzqonf4p9C2iMUOr8lWs3BoSXRAid5xi6R3+MvXPT0+u2gFHWj1YG9RRjoa8bWZHCSE3VbsovnyynETuvxgS84G9lN3iPRsm6gO7Q8IZ0J5YkdlX/csYeR6oQhKsmNmgIXwFrp7usCrgiaYH9BxieJcOy7BH1HOsWHJm7MuBS1rFloFEQB54XAoZ1II1JqKDwfOuovgCFIPbwB5PS3aLTWCwnwVqXsqfXe/QOnRAuel7bcR6HumqGaI+toiv7I48IcpOBHDHJrTWGDBEigg4dLztygPKWAt6zV/sY63reFe0WS69wlGmhwp4R8f35oc8hJH2NEVu25nvN2dRZ34M+6H/IVGqr90ijy2VU3ZLkk1JqCSDnJG9UgcwA7fodvChqGzSsf3V7KrlK9vGkQjxWVDPVEEkgTh+r+9cs5MwYQVpgyUN+BjmYQhSvLHJxsfbqayKEk3LoFp+qibbYwtij7h1VbeqmiSxUAAbqiYNqq+qbzYKynBnmcAH9kYxri2Y3DlnuVCDQfwSe5vM0RAb1oYIZBzm6u/1UUPj3rAHECNPtFu4uMCimdd8kUvyMK0O6mMp/Jd5MMIPBzk6CB/t4DjvR50BYGUDokSui+t2eZOJwTk+y5L3N++iijNBDS3NwGbh5f0vmaniBEfT/YzEvdZHeHGySKb86h4V7wUA18ECEwM21bqPVkJbof5baRtrTQ5zbXDkkAvqf2CAqyTD9RNoiOAB49EpH4SExO5PCInG/9LOPpoMXOZ3euH/eB6z6FzyuuFESWvEAv+01Wm+WJKBi7hK";
        
        var submitPass = document.getElementById('submitPass');
        var passEl = document.getElementById('pass');
        var invalidPassEl = document.getElementById('invalidPass');
        var trycatcherror = document.getElementById('trycatcherror');
        var successEl = document.getElementById('success');
        var contentFrame = document.getElementById('contentFrame');
        
        // Sanity checks

        if (pl === "") {
            submitPass.disabled = true;
            passEl.disabled = true;
            alert("This page is meant to be used with the encryption tool. It doesn't work standalone.");
            return;
        }

        if (!isSecureContext) {
            document.querySelector("#passArea").style.display = "none";
            document.querySelector("#securecontext").style.display = "block";
            return;
        }

        if (!crypto.subtle) {
            document.querySelector("#passArea").style.display = "none";
            document.querySelector("#nocrypto").style.display = "block";
            return;
        }
        
        function str2ab(str) {
            var ustr = atob(str);
            var buf = new ArrayBuffer(ustr.length);
            var bufView = new Uint8Array(buf);
            for (var i=0, strLen=ustr.length; i < strLen; i++) {
                bufView[i] = ustr.charCodeAt(i);
            }
            return bufView;
        }

        async function deriveKey(salt, password) {
            const encoder = new TextEncoder()
            const baseKey = await crypto.subtle.importKey(
                'raw',
                encoder.encode(password),
                'PBKDF2',
                false,
                ['deriveKey'],
            )
            return await crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
                baseKey,
                { name: 'AES-GCM', length: 256 },
                true,
                ['decrypt'],
            )
        }
        
        async function doSubmit(evt) {
            submitPass.disabled = true;
            passEl.disabled = true;

            let iv, ciphertext, key;
            
            try {
                var unencodedPl = str2ab(pl);

                const salt = unencodedPl.slice(0, 32)
                iv = unencodedPl.slice(32, 32 + 16)
                ciphertext = unencodedPl.slice(32 + 16)

                key = await deriveKey(salt, passEl.value);
            } catch (e) {
                trycatcherror.style.display = "inline";
                console.error(e);
                return;
            }

            try {
                const decryptedArray = new Uint8Array(
                    await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ciphertext)
                );

                let decrypted = new TextDecoder().decode(decryptedArray);

                if (decrypted === "") throw "No data returned";

                const basestr = '<base href="." target="_top">';
                const anchorfixstr = `
                    <script>
                        Array.from(document.links).forEach((anchor) => {
                            const href = anchor.getAttribute("href");
                            if (href.startsWith("#")) {
                                anchor.addEventListener("click", function(e) {
                                    e.preventDefault();
                                    const targetId = this.getAttribute("href").substring(1);
                                    const targetEl = document.getElementById(targetId);
                                    targetEl.scrollIntoView();
                                });
                            }
                        });
                    <\/script>
                `;
                
                // Set default iframe link targets to _top so all links break out of the iframe
                if (decrypted.includes("<head>")) decrypted = decrypted.replace("<head>", "<head>" + basestr);
                else if (decrypted.includes("<!DOCTYPE html>")) decrypted = decrypted.replace("<!DOCTYPE html>", "<!DOCTYPE html>" + basestr);
                else decrypted = basestr + decrypted;

                // Fix fragment links
                if (decrypted.includes("</body>")) decrypted = decrypted.replace("</body>", anchorfixstr + '</body>');
                else if (decrypted.includes("</html>")) decrypted = decrypted.replace("</html>", anchorfixstr + '</html>');
                else decrypted = decrypted + anchorfixstr;
                
                contentFrame.srcdoc = decrypted;
                
                successEl.style.display = "inline";
                setTimeout(function() {
                    dialogWrap.style.display = "none";
                }, 1000);
            } catch (e) {
                invalidPassEl.style.display = "inline";
                passEl.value = "";
                submitPass.disabled = false;
                passEl.disabled = false;
                console.error(e);
                return;
            }
        }
        
        submitPass.onclick = doSubmit;
        passEl.onkeypress = function(e){
            if (!e) e = window.event;
            var keyCode = e.keyCode || e.which;
            invalidPassEl.style.display = "none";
            if (keyCode == '13'){
              // Enter pressed
              doSubmit();
              return false;
            }
        }
    })();
    </script>
  </body>
</html>
